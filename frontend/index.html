<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loom â€” Knowledge Sidebar</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css?v=__CACHE_VERSION__">
</head>
<body>
  <div class="app-container">
    <!-- Left Sidebar -->
    <aside class="left-sidebar" id="leftSidebar">
      <div class="sidebar-header">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 2C12 2 6 8 6 14C6 17.5 8.5 20 12 22C15.5 20 18 17.5 18 14C18 8 12 2 12 2Z" fill="white" opacity="0.9"/>
            <ellipse cx="12" cy="14" rx="2" ry="3" fill="white" opacity="0.5"/>
          </svg>
        </div>
        <span class="logo-text">Loom</span>
      </div>

      <button class="new-chat-btn" id="newChatBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        New Chat
      </button>

      <div class="view-toggle" id="viewToggle">
        <button class="toggle-btn active" data-view="recent">Recent</button>
        <button class="toggle-btn" data-view="topics">By Topic</button>
      </div>

      <div class="chat-list" id="chatList"></div>

      <div class="sidebar-actions">
        <button class="new-topic-btn" id="newTopicBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5"/>
          </svg>
          New Topic
        </button>
      </div>

      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar">U</div>
          <div>
            <div class="user-name">User</div>
            <div class="user-role">Learner</div>
          </div>
        </div>
      </div>
    </aside>
    <div class="resize-handle" id="resizeLeft">
      <button class="sidebar-collapse-btn" id="collapseLeftBtn" title="Collapse sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="12" height="12">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
      </button>
    </div>

    <!-- Main Chat Area -->
    <main class="main-content" id="mainContent">
      <header class="chat-header" id="chatHeader">
        <span class="chat-title" id="chatTitle">New Chat</span>
        <span class="topic-badge" id="topicBadge" style="display:none;"></span>
      </header>

      <div class="chat-messages" id="chatMessages"></div>

      <!-- Context block (from drag-drop) -->
      <div class="context-block" id="contextBlock" style="display:none;">
        <div class="context-block-header">
          <span class="context-block-label">Added context</span>
          <div class="context-block-actions">
            <button class="context-toggle-btn" id="contextToggleBtn">Expand</button>
            <button class="context-close-btn" id="contextCloseBtn">&times;</button>
          </div>
        </div>
        <div class="context-block-compact" id="contextCompact"></div>
        <div class="context-block-full" id="contextFull" style="display:none;">
          <textarea id="contextFullText"></textarea>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="chat-input" id="chatInputArea">
          <div class="input-attachments" id="inputAttachments"></div>
          <div class="input-row">
            <button class="input-icon" id="attachBtn" title="Attach image or file">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
            </button>
            <textarea id="chatInput" rows="1" placeholder="Ask a question..."></textarea>
            <select class="input-topic-select" id="topicSelect" title="Assign to topic">
              <option value="">Auto-detect</option>
            </select>
            <button class="input-icon" id="searchToggleBtn" title="Google Search grounding">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
            </button>
            <select class="input-model-select" id="chatModelSelect">
              <optgroup label="Gemini">
                <option value="gemini-2.5-flash" selected>Flash</option>
                <option value="gemini-2.5-flash-lite">Flash Lite</option>
                <option value="gemini-3-flash-preview">3 Flash</option>
                <option value="gemini-3.1-pro-preview">3.1 Pro</option>
              </optgroup>
              <optgroup label="Gemini Live">
                <option value="gemini-2.0-flash-live-001">Live Flash</option>
              </optgroup>
              <optgroup label="OpenAI">
                <option value="gpt-5.2-2025-12-11">GPT-5.2</option>
                <option value="gpt-5-mini-2025-08-07">GPT-5 Mini</option>
                <option value="gpt-5-nano-2025-08-07">GPT-5 Nano</option>
              </optgroup>
            </select>
            <button class="send-btn" id="sendBtn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <line x1="22" y1="2" x2="11" y2="13"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
              </svg>
            </button>
          </div>
          <input type="file" id="fileInput" multiple accept="image/*,.pdf,.txt,.csv,.json" style="display:none;">
        </div>
      </div>
    </main>
    <div class="resize-handle" id="resizeRight">
      <button class="sidebar-collapse-btn" id="collapseRightBtn" title="Collapse sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="12" height="12">
          <polyline points="9 18 15 12 9 6"/>
        </svg>
      </button>
    </div>

    <!-- Right Sidebar -->
    <aside class="right-sidebar" id="rightSidebar">
      <div class="knowledge-header">
        <div class="knowledge-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"/>
            <path d="M2 12h20"/>
          </svg>
          Knowledge Sidebar
        </div>
        <div class="knowledge-header-row">
          <div class="knowledge-subtitle">Personalized context modules</div>
          <select class="model-select model-select-sm" id="sidebarModelSelect">
            <optgroup label="Gemini">
              <option value="gemini-2.5-flash" selected>gemini-2.5-flash</option>
              <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
              <option value="gemini-3-flash-preview">gemini-3-flash-preview</option>
              <option value="gemini-3.1-pro-preview">gemini-3.1-pro-preview</option>
              <option value="gemini-2.0-flash-live-001">gemini-2.0-flash-live</option>
            </optgroup>
            <optgroup label="OpenAI">
              <option value="gpt-5.2-2025-12-11">gpt-5.2-2025-12-11</option>
              <option value="gpt-5-mini-2025-08-07">gpt-5-mini-2025-08-07</option>
              <option value="gpt-5-nano-2025-08-07">gpt-5-nano-2025-08-07</option>
            </optgroup>
          </select>
        </div>
      </div>

      <div class="sidebar-content" id="sidebarContent">
        <div class="sidebar-empty" id="sidebarEmpty">
          <p>Start chatting to see your knowledge modules here.</p>
          <p class="sidebar-hint">The sidebar will surface relevant context when it detects a recurring topic.</p>
        </div>

        <!-- Module 1: Status Summary -->
        <div class="sidebar-module module-status" id="moduleStatus" style="display:none;">
          <div class="module-header">
            <span class="module-icon status-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </span>
            <span class="module-title" id="statusTopicName">Your Status</span>
          </div>
          <div class="status-content" id="statusContent">
            <div class="status-structured" id="statusStructured" draggable="true"></div>
            <div class="status-actions">
              <button class="status-edit-btn" id="statusUpdateBtn" style="color:var(--accent-blue);">Update</button>
            </div>
          </div>
        </div>

        <!-- Module 2: Related Cards -->
        <div class="sidebar-module module-related" id="moduleRelated" style="display:none;">
          <div class="module-header">
            <span class="module-icon related-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
              </svg>
            </span>
            <span class="module-title">Linked past chats</span>
          </div>
          <div class="related-cards" id="relatedCards"></div>
        </div>

        <!-- Module 3: New Directions -->
        <div class="sidebar-module module-directions" id="moduleDirections" style="display:none;">
          <div class="module-header">
            <span class="module-icon directions-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
              </svg>
            </span>
            <span class="module-title">Explore next</span>
          </div>
          <div class="direction-cards" id="directionCards"></div>
        </div>

        <!-- Refresh button -->
        <button class="sidebar-refresh-btn" id="sidebarRefreshBtn" style="display:none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
            <polyline points="23 4 23 10 17 10"/>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
          </svg>
          Refresh sidebar
        </button>
      </div>
    </aside>
  </div>

  <!-- New Topic Dialog -->
  <div class="dialog-overlay" id="newTopicDialog" style="display:none;">
    <div class="dialog">
      <h3>Create New Topic</h3>
      <label>Topic name</label>
      <input type="text" id="topicNameInput" placeholder="e.g., Machine Learning, Fitness">
      <label>Initial status (optional)</label>
      <textarea id="topicDescInput" rows="2" placeholder="Describe yourself in this area..."></textarea>
      <div class="dialog-actions">
        <button class="btn-cancel" id="topicCancelBtn">Cancel</button>
        <button class="btn-save" id="topicCreateBtn">Create</button>
      </div>
    </div>
  </div>

  <!-- Merge Topics Dialog -->
  <div class="dialog-overlay" id="mergeTopicDialog" style="display:none;">
    <div class="dialog">
      <h3>Merge Topics</h3>
      <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">Select a topic to merge into the current one. All chats will be reassigned and the status will be regenerated.</p>
      <label>Merge into current topic:</label>
      <div class="merge-current-topic" id="mergeCurrentTopic" style="font-weight:600;margin-bottom:8px;"></div>
      <label>Topic to absorb:</label>
      <select id="mergeTargetSelect" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit;"></select>
      <div class="dialog-actions">
        <button class="btn-cancel" id="mergeCancelBtn">Cancel</button>
        <button class="btn-save" id="mergeConfirmBtn">Merge</button>
      </div>
    </div>
  </div>

  <script src="/static/utils.js?v=__CACHE_VERSION__"></script>
  <script src="/static/storage.js?v=__CACHE_VERSION__"></script>
  <script src="/static/sidebar.js?v=__CACHE_VERSION__"></script>
  <script src="/static/app.js?v=__CACHE_VERSION__"></script>
</body>
</html>
